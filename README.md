# Рекомендательная система для продуктов Amazon

## Постановка задачи
Задача состоит в разработке рекомендательной системы, способной выдавать персонализированные рекомендации пользователям в реальном времени. Система должна учитывать отзывы пользователей на товары и использовать их для построения информативных эмбеддингов как для пользователей, так и для продуктов.

## Формат входных и выходных данных

- **Входные данные:**  
  Все комментарии конкретного пользователя на товары, с полями:
  - `reviewID` — Идентификатор отзыва
  - `nickname` — Псевдоним пользователя
  - `ProductName` — Название товара
  - `TextReview` — Текст отзыва
  - `Style` — Категория товара
  - `asin` — Уникальный идентификатор товара
  
- **Выходные данные:**  
  Информативные эмбеддинги для пользователей, собранные на основе их фидбека и комментариев, а также эмбеддинги для предоставляемых продуктов.

## Метрики

Основные метрики для оценки модели:
- **F1-score**
- **Accuracy**
- **loss**

## Валидация и тест

Для разделения выборки используется случайное разбиение: из исходного обучающего набора выделяется 10% юзеров для валидации с помощью функции `random_split` из `torch.utils.data.dataset`.

Для контроля ключевых метрик (F1-score, loss, Accuracy) будет использован **MLflow**.

## Датасеты

В качестве исходных данных используется [Amazon Review Data](https://nijianmo.github.io/amazonl) в разделе **musical instruments**. Этот датасет включает 231392 JSON объектов, каждый из которых представляет собой отзыв пользователя на товар. Каждый объект содержит следующие поля:
- `reviewID` — Идентификатор отзыва
- `nickname` — Псевдоним пользователя
- `ProductName` — Название товара
- `TextReview` — Текст отзыва
- `Style` — Категория товара

## Основная модель

Эмбеддинги пользователей и продуктов формируются с использованием модели **all-MiniLM-L6-v2**. Затем строятся рёбра в графе, где рёбра представляют эмбеддинги комментариев пользователей к продуктам. 

После этого выполняется **message passing** с использованием **attention** с применением одного из алгоритмов графовых нейронных сетей, таких как **GAT** (Graph Attention Network) или **TransformerConv**. Эти алгоритмы доступны в библиотеке **PyTorch Geometric** (https://pytorch-geometric.readthedocs.io/en/latest/generated/torch_geometric.nn.conv.TransformerConv.html).

Формула для финальной функции потерь (лосс-функции):
$$
\text{loss} = \frac{5}{2} \times (\text{cos\_sim}(\texttt{cust\_emb}, \texttt{prod\_emb}) + 1)
$$
где:
- `cust_emb` — эмбеддинг пользователя
- `prod_emb` — эмбеддинг продукта
- `cos_sim` — косинусное сходство между эмбеддингами пользователя и продукта

Цель модели — минимизировать лосс, что будет способствовать улучшению качества рекомендаций, основанных на комментариях пользователей.

- `asin` — Уникальный идентификатор товара

Этот датасет будет использован для построения рекомендательной системы и генерации персонализированных рекомендаций.



## Setup

Для настройки проекта выполните следующие шаги:

1. **Клонируйте репозиторий:**

`git clone https://github.com/FlexxofIvan/recommend-system.git`

2. **Перейдите в директорию проекта:**
   
`cd recommend-system`

3. **Установите зависимости с помощью uv:**

`uv sync`

4. ***Установка и запуска pre-commit:**
```bash
uv run pre-commit install
uv run pre-commit run -a
```

## Train

```bash
 uv run -m rec_sys.train.train
```
Подгружает данные для обучения с гугл диска, обучает модель на них.

### Inference

Для инференса необходимо прописать в:

```bash
  config/infer_config.yaml 
```
путь до нужного чекпоинта.

Затем создать векторную базу данных для продуктов:
```bash
  uv run -m rec_sys.vector_database.create_vectorbase
```

Сам инференс:
```bash
  uv run -m rec_sys.inference.infer
```

### Production Preparation

Экспортируем нужную нам модель:
```bash
  uv run python -m rec_sys.modules.model_export \
    ./checkpoints/<checkpoint name> \
    ./config/model/model_config.yaml \
    --output_path=./triton_utils/model_repository/graph_model/1/model.onnx
```





